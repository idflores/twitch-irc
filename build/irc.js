'use strict';var _createClass=function(){function a(b,c){for(var f,d=0;d<c.length;d++)f=c[d],f.enumerable=f.enumerable||!1,f.configurable=!0,'value'in f&&(f.writable=!0),Object.defineProperty(b,f.key,f)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_net=require('net'),_net2=_interopRequireDefault(_net),_msg=require('./msg.js'),_msg2=_interopRequireDefault(_msg),_events=require('events'),_events2=_interopRequireDefault(_events);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}module.exports=function(){function a(b,c){var d=2<arguments.length&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,a),this.oauth=b,this.username=c,this.debug_mode=d;var f=this.history=[],g=this.channel=[],h=this.clientState={};this.clientState.state=!1;var j=this.client=_net2.default.connect(6667,'irc.chat.twitch.tv');j.setEncoding('utf8');var k=this.chatEvents=new _events2.default;j.addListener('connect',function(){j.write('PASS '+b+'\r\n'),j.write('NICK '+c.toLowerCase()+'\r\n'),d?(console.log('Established connection'),console.log(j.address())):console.log('You\'re connected!'),h.state=!0}),j.addListener('data',function(l){serverResponse(l,f,j,d,k)}),j.addListener('error',function(l){d?(console.log('ERROR with Twitch server'),console.log(l.toString())):console.log('ERROR: Check your username and password'),h.state=!1}),j.addListener('end',function(){h.state=!1,console.log('You have disconnected.')})}return _createClass(a,[{key:'join',value:function join(b){var c=this,d=this.debug_mode,f=this.channel;try{if(!1===this.clientState.state)throw'ERROR'}catch(g){return void setTimeout(function(){return c.join(b)},1e3)}try{if(this.channel.includes(b))throw'ERROR: Channel already joined';console.log('Joining '+b+'...');var g=this.history,h=this.client,j=setInterval(function(){h.write('JOIN #'+b.toLowerCase()+'\r\n')},500),k=setInterval(function(){var m=g.length-3;try{'JOIN'===g[m].tag&&(console.log('You have joined '+b+'!'),clearInterval(j),clearInterval(k),clearTimeout(l),f.push(b))}catch(n){d&&console.log('WARNING: failed to join '+b+'. Trying again...')}},20),l=setTimeout(function(){console.log('ERROR: Cannot join '+b+'. Check your spelling...'),clearInterval(j),clearInterval(k)},5e3)}catch(g){console.log(g)}}},{key:'chat',value:function chat(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;try{if(null===c){var d=this.channel.length-1;if(-1==d)throw'ERROR: You must join a channel first';this.client.write('PRIVMSG #'+this.channel[d].toLowerCase()+' :'+b+'\r\n');var f=new _msg2.default;f.meta_host=this.username,f.host='tmi.twitch.tv',f.tag='PRIVMSG',f.channel=this.channel[d],f.message=messsage,this.history.push(f)}else if(this.channel.includes(c)){this.client.write('PRIVMSG #'+c.toLowerCase()+' :'+b+'\r\n');var d=new _msg2.default;d.meta_host=this.username,d.host='tmi.twitch.tv',d.tag='PRIVMSG',d.channel=c,d.message=messsage,this.history.push(d)}else throw'ERROR: You must chat a channel that has already been joined'}catch(d){console.log(d)}}},{key:'leave',value:function leave(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;try{if(null===b){var c=this.channel.length-1;if(-1==c)throw'ERROR: You called "leave()". You have not joined a channel yet';this.client.write('PART #'+this.channel[c].toLowerCase()+'\r\n'),console.log('You left '+this.channel[c]),this.channel.pop()}else if(this.channel.includes(b))this.client.write('PART #'+b.toLowerCase()+'\r\n'),console.log('You left '+b),this.channel.splice(this.channel.indexOf(b),1);else throw'ERROR: Cannot leave'+b+'. You have not joined that channel yet.'}catch(c){console.log(c)}}},{key:'getChannels',value:function getChannels(){return 0===this.channel.length?console.log('Channel List: <no joined channels>'):console.log('Channel List: '+this.channel),this.channel}},{key:'getChatHistory',value:function getChatHistory(){var b=0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(this.debug_mode||b)return console.log(this.history),this.history;var c=[];console.log('HISTORY=========================');for(var d=0;d<this.history.length;d++)if('PRIVMSG'===this.history[d].tag){console.log('['+this.history[d].channel+'] '+this.history[d].meta_host+': '+this.history[d].message);var f='['+this.history[d].channel+'] '+this.history[d].meta_host+': '+this.history[d].message;c.push(f)}return console.log('END HISTORY====================='),c}}]),a}();function serverResponse(a,b,c,d,f){a=a.toString();for(var g=new RegExp(/tmi\.twitch\.tv/),h=new RegExp(/:jtv/);-1!==a.search(/\r\n/);){var j=null,k=null,l=null,m=null,n=null,o=null;j=a.search(/\r\n/),200<b.length&&b.shift(),b.push(new _msg2.default);var p=b.length-1;b[p].raw=a.substring(0,j),a=a.substring(j+2);try{if(-1!==b[p].raw.search(g)){var q=b[p].raw;if(n=q.search(g),k=q.search(/:/),-1!==q.search(/PING/)){b[p].host='tmi.twitch.tv',b[p].tag='PING',c.write('PONG :tmi.twitch.tv \r\n');continue}0!==k&&(b[p].meta=q.substring(0,k),q=q.substring(k)),1!=n-k&&(b[p].meta_host=q.substring(k+1,n-1),-1!==b[p].meta_host.search(/\!/)&&(o=b[p].meta_host.search(/\!/),b[p].meta_host=b[p].meta_host.substring(k,o)),q=q.substring(n-1),n=1),b[p].host=q.match(g).toString(),q=q.substring(n+14),-1!==q.search(/:/)&&(k=q.search(/:/),b[p].message=q.substring(k+1),q=q.substring(0,k-1)),-1!==q.search(/#/)&&(l=q.search(/#/),b[p].channel=q.substring(l+1),q=q.substring(0,l-1)),isNaN(q.substring(0,3))||(b[p].status=q.substring(0,3),q=q.substring(4)),q.substring(0,3)!==q.substring(0,3).toUpperCase()&&(m=q.search(' '),-1===m?(b[p].user=q,q=null):(b[p].user=q.substring(0,m),q=q.substring(m+1))),null!==q&&(b[p].tag=q)}else if(-1!==b[p].raw.search(h)){var q=b[p].raw.split(' ');b[p].host=q[0].substring(1),b[p].tag=q[1],b[p].channel=q[2].substring(1),b[p].jtv_action=q[3],b[p].user=q[4]}else throw'ERROR: Cannot identify the host!'}catch(q){b[p].error=q,console.log(b[p].error);continue}d?(console.log(b[p]),f.emit('message',b[p])):'PRIVMSG'===b[p].tag&&(console.log('['+b[p].channel+'] '+b[p].meta_host+': '+b[p].message),f.emit('message',b[p].channel,b[p].meta_host,b[p].message))}}